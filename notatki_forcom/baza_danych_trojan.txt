<!--SPRAWDZENIE PRZESTRZENI RECOVERY--->
show parameter db_recovery;
select * from v$flash_recovery_area_usage;
select * from v$recovery_file_dest;


<!--ORACLE XE CROSSCHECK--->
CROSSCHECK ARCHIVELOG ALL;
DELETE NOPROMPT EXPIRED ARCHIVELOG ALL;



Logujemy siê do sqlplusa na sys i wykonujemy polecenia:

sys as sysdba
ossef[sieæ]

SHUTDOWN IMMEDIATE;											--Jeœli siê zawiesi to wtedy SHUTDOWN ABORT; i ponownie immediate.
STARTUP MOUNT;
ALTER DATABASE ARCHIVELOG;
ALTER SYSTEM SET DB_RECOVERY_FILE_DEST_SIZE = 60G;
ALTER DATABASE OPEN;
COMMIT;

<!--ZIMNY BACKUP--->
sc stop cashregisterserver
sc stop oracleservicexe
sc stop ftpclientservice

KOPIA F:\BACKUP\ONLINELOG  > D:\Kopia_2015_05_07
KOPIA D:\Oracle\Oradata\XE > D:\Kopia_2015_05_07

sc start oracleservicexe

RMAN>
connect target;
shutdown immediate;
startup mount;
restore controlfile from backup;
restore database;
recover database;			--until sequence 1111			--sqlplus i recover database until cancel nastepnie AUTO
alter database open;
EXIT

sc start cashregisterserver
sc start ftpclientservice

<!--WERYFIKACJA PLIKÓW BAZODANOWYCH--->
dbv.exe FILE=CONTROL.DBF blocksize = 16384
dbv.exe FILE=SYSAUX.DBF blocksize = 8192
dbv.exe FILE=SYSTEM.DBF blocksize = 8192
dbv.exe FILE=UNDO.DBF blocksize = 8192
dbv.exe FILE=USERS.DBF blocksize = 8192

Select dbms_utility.data_block_address_file('334730640'), dbms_utility.data_block_address_block('334730640') from dual;

select tablespace_name, segment_type, owner, segment_name from dba_extents where file_id = 4 and 178691 between block_id AND block_id + blocks-1; 

<!--DUMP databazy Oracle--->
c:\forcom\oraclexe\app\oracle\product\11.2.0\server\bin\
exp market_user/for8667319com FILE=E:\dane\market\dumpy\53315.DMP LOG=E:\dane\market\dumpy\53315.log statistics=none
exp market_user/for8667319com FILE=D:\MarketUser_30102018.DMP LOG=D:\MarketUser_30102018.log statistics=none
exp market_user/for8667319com FILE=Q:\datapump\market.DMP LOG=Q:\datapump\log.txt consistent=no statistics=none
exp cashregisterserver/for8667319com FILE=D:\CashRegisterServer_20032019.DMP LOG=D:\CashRegisterServer_20032019.log statistics=none
expdp market_user/for8667319com@xe DIRECTORY=DUMP_DAILY_DIR DUMPFILE=DUMP.DMP LOGFILE=exp.log
exp market3_user/for8667319com FILE=D:\MarketUser_29032019.DMP LOG=D:\MarketUser_29032019.log statistics=none
exp cashregisterserver/for8667319com FILE=E:\dane\market\dumpy\53315_cs.DMP LOG=E:\dane\market\dumpy\53315_cs.log statistics=none

<!--TWORZENIE PRZESTRZENI DO EXPDP-->
CREATE OR REPLACE DIRECTORY DUMP_DAILY_DIR AS 'Q:\datapump\';
GRANT READ, WRITE ON DIRECTORY DUMP_DAILY_DIR TO market_user;

<!--PAKOWANIE DUMPA--->
7za a -t7z MarketUser.7z KALISZ_20150531.DMP
7za a -t7z CashRegisterServer.7z CashRegisterServer_*.DMP

<!--IMPORT BAZY--->
imp market_user/for8667319com@127.0.0.1/xe file=D:\dumpy\MarketUser_14032019.DMP log=D:\dumpy\logimp.txt statistics=none
imp market_user/for8667319com@127.0.0.1/xe file=CashRegisterServer_14022018.DMP log=logimpcs.txt statistics=none
imp market_user/for8667319com@127.0.0.1/xe FILE=Q:\market.DMP LOG=Q:\log.txt statistics=none
imp market3_user/for8667319com@127.0.0.1/xe FILE=D:\MarketUser_04012019.DMP LOG=D:\logimpmu.txt statistics=none
imp market3_user/for8667319com@127.0.0.1/xe FILE=D:\cashregisterserver_04012019.DMP LOG=D:\logimpcrs.txt statistics=none

impdp market_user/for8667319com@xe DIRECTORY=DUMP_DAILY_DIR DUMPFILE=DUMP_20170715_033004.DMP full=y LOGFILE=imp.log

<!--IMPORT JEDNEJ TABELI-->
imp market_user/for8667319com@127.0.0.1/xe file=k.dmp tables=uzytk log=logimp.txt statistics=none

--UGNOJONE SEQUENCE'RY
select EVENT_SEQ.nextval from dual;
--4402892
select max(eventid) from event;
--4460345
-- od MAX odj¹æ wartoœæ SEQ, increment o t¹ wartoœæ.
alter sequence EVENT_SEQ increment by 58453;
select EVENT_SEQ.nextval from dual;
alter sequence EVENT_SEQ increment by 1;
select EVENT_SEQ.nextval from dual;

--UGNOJONE REDO 333
select l.status, member from v$logfile inner join v$log l using (group#);
 
STATUS  MEMBER
------------- --------------------------------------
CURRENT /oracle/fast_recovery_area/redo01.log
INACTIVE /oracle/fast_recovery_area/redo02.log
INACTIVE /oracle/fast_recovery_area/redo03.log
 
recover database using backup controlfile;
ORA-00280: change  for thread 1 is in sequence #
Specify log: {=suggested | filename | AUTO | CANCEL}

Step3: Give 'CURRENT' log file member along with location as input.
alter database open resetlogs;

--UGNOJONE REDO 354
select * from v$log;
Jeœli jest jakiœ INACTIVE, mo¿na zrobiæ :
shutdown immediate;
startup mount;
ALTER DATABASE CLEAR UNARCHIVED LOGFILE GROUP 3;
alter database open;
alter system switch logfile;
backup.bat

--
select * from USER$ u where u.name like 'MARKET3%';
ALTER USER market3_user identified by  for8667319com Account unlock;
ALTER PROFILE DEFAULT LIMIT PASSWORD_LIFE_TIME UNLIMITED;
ALTER USER market3_user identified by for8667319com;
ALTER USER CASHREGISTERSERVER identified by for8667319com;


<!--POSZERZENIE UNDOTBS1-->
select b.tablespace_name, tbs_size SizeMb, a.free_space FreeMb from (select tablespace_name, round(sum(bytes)/1024/1024 ,2) as free_space from dba_free_space group by tablespace_name) a, (select tablespace_name, sum(bytes)/1024/1024 as tbs_size from dba_data_files group by tablespace_name UNION select tablespace_name, sum(bytes)/1024/1024 tbs_size from dba_temp_files group by tablespace_name ) b where a.tablespace_name(+)=b.tablespace_name;

ALTER DATABASE DATAFILE 'E:\oraclexe\app\oracle\oradata\XE\UNDOTBS1.DBF' AUTOEXTEND ON MAXSIZE 1g;
ALTER DATABASE DATAFILE 'E:/oraclexe/oradata/XE/UNDO.DBF' AUTOEXTEND ON MAXSIZE 1g;

<!--GENEROWANIE PSCN DLA SKLEPU - LC KATOWICE-->
D:\Aplikacje\forcom\market\exporter.exe -t CNPS -n 1301

<!--ZEROWE CNPS LECLERC-->
Zgodnie z Olesiem, trzeba usun¹æ pliki z katalogów importowych oraz z bazy Centrali

<!--BIGSTAR - SNAPSHOT TOO OLD-->
delete from PROMOCJAWARUNEK where SGUID = '{66E6BC09-39B5-45C1-8847-FF7EE09DAA93}';

<!--WY£¥CZENIE/W£¥CZENIE CONSTRAINTÓW I TRIGGERÓW-->
call DisableAllConstraints();
call DisableAllTriggers();

call EnableAllConstraints();
call EnableAllTriggers();

<!--WYSZUKIWANIE I USUWANIE DUBLI W BAZIE-->
select pcs.PRODUCT_ID, count(*) from PRODUCT_STOCK_INFO pcs group by PRODUCT_ID order by COUNT(*) desc;

DELETE FROM tabela
WHERE rowid not in
(SELECT MIN(rowid)
FROM tabela
GROUP BY kolumna1, kolumna2, kolumna3);

<!--SHRINKOWANIE TABEL-->
SELECT OWNER, SEGMENT_NAME, SUM(BYTES)/1024/1024 "SIZE IN MB" FROM dba_segments WHERE OWNER = 'MARKET_USER' OR OWNER = 'CASHREGISTERSERVER' GROUP BY OWNER, SEGMENT_NAME ORDER BY 3 desc;

select count(*) FROM log WHERE czasmod <= floor(borlandsysdate) - 30;
DELETE FROM log WHERE czasmod <= floor(borlandsysdate) - 30 AND rownum <= 250000;
commit;
ALTER TABLE market_user.log ENABLE ROW MOVEMENT;
ALTER TABLE market_user.log SHRINK SPACE;
ALTER TABLE market_user.log SHRINK SPACE COMPACT;
ALTER TABLE market_user.log DISABLE ROW MOVEMENT;
analyze table market_user.log compute statistics;