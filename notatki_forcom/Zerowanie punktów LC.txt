Przed odpalaniem zapytań z załącznika w LekartMenu zrobić zestawienia:
1 - karty -> zestawienie kart dla kart ze STANEM KONTA > 0 i DATĄ OSTATNIEJ WIZYTY < 01.01.2017 stąd wziąć kilka kart i zanotować ich stany kont - to będą karty, których stany muszą zostać wyzerowane.
2 - karty -> zestawienie kart dla kart ze STANEM KONTA > 0 i DATĄ OSTATNIEJ WIZYTY >= 01.01.2017 stąd wziąć kilka kart i zanotować ich stany kont i wartość pkt przyznanych w styczniu (ppm -> transakcje karty)  - to będą karty na których mają zostać punkty zdobyte w styczniu
Po wykonaniu procedury proszę o weryfikację dla zanotowanych kart czy 1- konta zostały wyczyszczone, 2- czy zostały pkt tylko z stycznia.

--0 utworzenie kopii tabel - na wszelki wypadek
create table ok_karta_180930 as select * from karta;
create table ok_kartatrans_180930 as select * from kartatrans;

--1
insert into kartatrans
select newref LKARTATRANSREF, LKARTAREF, BORLANDSYSDATE CZASTRANS, floor(BORLANDSYSDATE) LDZIENTRANS, 0 NGODZINA, 0 NNRKASY, 79 NTYPTRANSAKCJI, 0 NNRPARAG,0 NNRKASJERA,0 DWARTPARAG, do_wycofania DWARTWYKPREM,
Pozostaje  DSTANKONTAPO,  0 DWARTPRZYZNPREM, 2 LUZYTKREF, 1 NSTATUS, 0 NSTATUSEKSPORTU, 0 LFLAGS, 0 NNRZMIANY, 0 LDZIENZMIANY, '' TRANSGUID,'' INRSKLEPU
from (
select x.*, decode ( sign(to_number(DAKTSTANKONTA) - to_number(PunktyPrzyznanewokresie)), 0, PunktyPrzyznanewokresie, 1, PunktyPrzyznanewokresie, -1 ,DAKTSTANKONTA ) Pozostaje, DAKTSTANKONTA - decode ( sign(to_number(DAKTSTANKONTA) - to_number(PunktyPrzyznanewokresie)), 0, PunktyPrzyznanewokresie, 1, PunktyPrzyznanewokresie, -1 ,DAKTSTANKONTA ) do_wycofania from
(select sum(kt.DWARTPRZYZNPREM) PunktyPrzyznanewokresie, k.DAKTSTANKONTA, k.SNRKARTY, k.LKARTAREF   from karta k, KARTATRANS kt where
                k.DAKTSTANKONTA > 0
                and k.LKARTAREF  = kt.LKARTAREF
                and kt.LDZIENTRANS >=42736
                and (kt.NTYPTRANSAKCJI = 1 or kt.NTYPTRANSAKCJI = 3)
--              and kt.LKARTAREF = 26224586
                and kt.DWARTPRZYZNPREM >0
group by k.DAKTSTANKONTA, k.SNRKARTY, k.LKARTAREF ) X     where x.PunktyPrzyznanewokresie < DAKTSTANKONTA
)
union all
select newref LKARTATRANSREF, k.LKARTAREF LKARTAREF, BORLANDSYSDATE CZASTRANS, floor(BORLANDSYSDATE) LDZIENTRANS, 0 NGODZINA,0 NNRKASY, 79 NTYPTRANSAKCJI,0 NNRPARAG,0 NNRKASJERA,0 DWARTPARAG, k.DAKTSTANKONTA DWARTWYKPREM,
0 DSTANKONTAPO, 0 DWARTPRZYZNPREM, 2 LUZYTKREF, 1 NSTATUS,  0 NSTATUSEKSPORTU, 0 LFLAGS,  0 NNRZMIANY, 0 LDZIENZMIANY, '' TRANSGUID,'' INRSKLEPU
from karta k where not exists (select 1 from KARTATRANS kt
                                where kt.LKARTAREF = k.LKARTAREF
                        and kt.LDZIENTRANS >=42736
                                and (kt.NTYPTRANSAKCJI = 1 or kt.NTYPTRANSAKCJI = 3)
                                and kt.DWARTPRZYZNPREM >0)
                and k.DAKTSTANKONTA >  0;

--2
update karta k set k.DAKTSTANKONTA = (select kt.DSTANKONTAPO from KARTATRANS kt where kt.NTYPTRANSAKCJI = 79 and kt.LDZIENTRANS >= floor(BORLANDSYSDATE) -1 and k.LKARTAREF = kt.LKARTAREF )
where exists (select 1 from KARTATRANS kt where kt.NTYPTRANSAKCJI = 79 and kt.LDZIENTRANS >= floor(BORLANDSYSDATE) -1 and k.LKARTAREF = kt.LKARTAREF);

--3
update kartatrans k set k.NTYPTRANSAKCJI = 3 where k.NTYPTRANSAKCJI = 79 and k.LDZIENTRANS >= floor(BORLANDSYSDATE) -1;